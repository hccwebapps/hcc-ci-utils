description: >
  Build, tag, and push the app runtime stage of the docker image.
parameters:
  dockerfile:
    type: string
    default: compose/production/django/Dockerfile
  target:
    type: string
    default: app_runtime
steps:
  - run:
      command: |
        docker build -t ${CIRCLE_PROJECT_REPONAME}:circleci-app-runtime -f << parameters.dockerfile >> \
        --target << parameters.target >> \
        --cache-from ${AWS_ECR_ACCOUNT_URL}/${CIRCLE_PROJECT_REPONAME}:circleci-app-build \
        --cache-from ${AWS_ECR_ACCOUNT_URL}/${CIRCLE_PROJECT_REPONAME}:circleci-app-runtime \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --build-arg APP_VERSION=${CIRCLE_SHA1} \
        --progress=plain \
        .
  - run:
      command: |
        docker tag ${CIRCLE_PROJECT_REPONAME}:circleci-app-runtime ${AWS_ECR_ACCOUNT_URL}/${CIRCLE_PROJECT_REPONAME}:circleci-app-runtime
        docker push ${AWS_ECR_ACCOUNT_URL}/${CIRCLE_PROJECT_REPONAME}:circleci-app-runtime
